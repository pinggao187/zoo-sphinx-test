

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automated Time Series Prediction &mdash; analytics-zoo  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> analytics-zoo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">PythonAPI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.automl.html">zoo.automl package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.common.html">zoo.common package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.examples.html">zoo.examples package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.feature.html">zoo.feature package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.models.html">zoo.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.orca.html">zoo.orca package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.pipeline.html">zoo.pipeline package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.ray.html">zoo.ray package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.tfpark.html">zoo.tfpark package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.util.html">zoo.util package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zoo.zouwu.html">zoo.zouwu package</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../DockerUserGuide/index.html">Docker User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/install.html"><strong>Install the latest nightly build wheels for pip</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/install.html#install-from-pip-for-local-usage"><strong>Install from pip for local usage</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/install.html#install-from-pip-for-yarn-cluster"><strong>Install from pip for Yarn cluster</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/install.html#install-without-pip"><strong>Install without pip</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/run.html"><strong>Run after pip install</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/run.html#run-on-yarn-after-pip-install"><strong>Run on Yarn after pip install</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/run.html#run-without-pip-install"><strong>Run without pip install</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PythonUserGuide/run.html#example-code"><strong>Example code</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DeveloperGuide/python.html"><strong>Download Analytics Zoo Source Code</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DeveloperGuide/python.html#build-whl-package-for-pip-install"><strong>Build whl package for pip install</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DeveloperGuide/python.html#run-in-ide"><strong>Run in IDE</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html"><strong>Download a pre-built library</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#link-with-a-release-version"><strong>Link with a release version</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#link-with-a-development-version"><strong>Link with a development version</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#download-analytics-zoo-source"><strong>Download Analytics Zoo Source</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#setup-build-environment"><strong>Setup Build Environment</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#build-with-script-recommended"><strong>Build with script (Recommended)</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#build-for-spark-1-6"><strong>Build for Spark 1.6</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#build-for-scala-2-10-or-2-11"><strong>Build for Scala 2.10 or 2.11</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#build-with-maven"><strong>Build with Maven</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/install.html#setup-ide"><strong>Setup IDE</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/run.html"><strong>Set Environment Variables</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/run.html#use-interactive-spark-shell"><strong>Use Interactive Spark Shell</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ScalaUserGuide/run.html#run-as-a-spark-program"><strong>Run as a Spark Program</strong></a></li>
</ul>
<p class="caption"><span class="caption-text">Programming Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nnframes.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nnframes.html#examples">Examples:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nnframes.html#primary-apis">Primary APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autograd.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transferlearning.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inference.html"><strong>Load and predict with pre-trained model</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../inference.html#examples"><strong>Examples</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../pytorch.html">System Requirement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pytorch.html#pytorch-api">Pytorch API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pytorch.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rayonspark.html"><strong>Introduction</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../rayonspark.html#steps-to-run-rayonspark"><strong>Steps to run RayOnSpark</strong></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">analytics-zoo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Automated Time Series Prediction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/ProgrammingGuide/AutoML/forecasting.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="automated-time-series-prediction">
<h1>Automated Time Series Prediction<a class="headerlink" href="#automated-time-series-prediction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="training-a-model-using-timesequencepredictor">
<h2>Training a model using <em>TimeSequencePredictor</em><a class="headerlink" href="#training-a-model-using-timesequencepredictor" title="Permalink to this headline">¶</a></h2>
<p><em>TimeSequencePredictor</em> can be used to train a model on historical time sequence data and predict future sequences. Note that:</p>
<ul class="simple">
<li>We require input time series data to be uniformly sampled in timeline. Missing data points will lead to errors or unreliable prediction result.</li>
</ul>
<div class="section" id="before-training-init-rayonspark">
<h3>1. Before training, init RayOnSpark.<a class="headerlink" href="#before-training-init-rayonspark" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Run ray on spark local mode, Example</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zoo</span> <span class="kn">import</span> <span class="n">init_spark_on_local</span>
<span class="kn">from</span> <span class="nn">zoo.ray</span> <span class="kn">import</span> <span class="n">RayContext</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">init_spark_on_local</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ray_ctx</span> <span class="o">=</span> <span class="n">RayContext</span><span class="p">(</span><span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">)</span>
<span class="n">ray_ctx</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li>run ray on yarn cluster, Example</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zoo</span> <span class="kn">import</span> <span class="n">init_spark_on_yarn</span>
<span class="kn">from</span> <span class="nn">zoo.ray</span> <span class="kn">import</span> <span class="n">RayContext</span>
<span class="n">slave_num</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">init_spark_on_yarn</span><span class="p">(</span>
        <span class="n">hadoop_conf</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hadoop_conf</span><span class="p">,</span>
        <span class="n">conda_name</span><span class="o">=</span><span class="s2">&quot;ray36&quot;</span><span class="p">,</span>
        <span class="n">num_executor</span><span class="o">=</span><span class="n">slave_num</span><span class="p">,</span>
        <span class="n">executor_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">executor_memory</span><span class="o">=</span><span class="s2">&quot;8g &quot;</span><span class="p">,</span>
        <span class="n">driver_memory</span><span class="o">=</span><span class="s2">&quot;2g&quot;</span><span class="p">,</span>
        <span class="n">driver_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">extra_executor_memory_for_ray</span><span class="o">=</span><span class="s2">&quot;10g&quot;</span><span class="p">)</span>
<span class="n">ray_ctx</span> <span class="o">=</span> <span class="n">RayContext</span><span class="p">(</span><span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span> <span class="n">object_store_memory</span><span class="o">=</span><span class="s2">&quot;5g&quot;</span><span class="p">)</span>
<span class="n">ray_ctx</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-timesequencepredictor">
<h3>2. Create a <em>TimeSequencePredictor</em><a class="headerlink" href="#create-a-timesequencepredictor" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">dt_col</span></code> and <code class="docutils literal notranslate"><span class="pre">target_col</span></code> are datetime cols and target column in the input dataframe</li>
<li><code class="docutils literal notranslate"><span class="pre">future_seq_len</span></code> is how many data points ahead to predict.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zoo.automl.regression.time_sequence_predictor</span> <span class="kn">import</span> <span class="n">TimeSequencePredictor</span>
<span class="n">tsp</span> <span class="o">=</span> <span class="n">TimeSequencePredictor</span><span class="p">(</span><span class="n">dt_col</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">target_col</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">extra_features_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">future_seq_len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="train-on-historical-time-sequence">
<h3>3. Train on historical time sequence.<a class="headerlink" href="#train-on-historical-time-sequence" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">recipe</span></code> contains parameters to control the search space, stop criteria and number of samples (e.g. for random search strategy, how many samples are taken from the search space). Some recipe with large number of samples may lead to a large trial pool and take very long time to finish. Current avaiable recipes are: <em>SmokeRecipe</em>, <em>RandomRecipe</em>, <em>GridRandomRecipe</em> and <em>BayesRecipe</em>. <em>SmokeRecipe</em> is a very simple Recipe for smoke test that runs one epoch and one iteration with only 1 random sample. Other recipes all have arguments <code class="docutils literal notranslate"><span class="pre">num_random_samples</span></code> and <code class="docutils literal notranslate"><span class="pre">look_back</span></code>. <code class="docutils literal notranslate"><span class="pre">num_random_samples</span></code> is used to control the number of samples. Note that for GridRandomRecipe, the actual number of trials generated will be 2*<code class="docutils literal notranslate"><span class="pre">num_samples</span></code>, as it needs to do a grid search from 2 possble values for every random sample. <code class="docutils literal notranslate"><span class="pre">look_back</span></code> is the length of sequence you want to look back. The default values is 1. You can either put a tuple of (min_len, max_len) or a single int to control the look back sequence length search space. <em>BayesRecipe</em> use bayesian-optimization package to perform sequential model-based hyperparameter optimization.</li>
<li><code class="docutils literal notranslate"><span class="pre">distributed</span></code>specifies whether to run it in a distributed fashion.</li>
<li><code class="docutils literal notranslate"><span class="pre">fit</span></code> returns a <em>Pipeline</em> object (see next section for details).</li>
<li>Now we don’t support resume training - i.e. calling <code class="docutils literal notranslate"><span class="pre">fit</span></code> multiple times retrains on the input data from scratch.</li>
<li>input train dataframe look like below:</li>
</ul>
<p>|datetime|value|
| ——–|—– |
|2019-06-06|1.2|
|2019-06-07|2.3|…|</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">tsp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="n">RandomRecipe</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">distributed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="after-training-finished-stop-rayonspark">
<h3>4. After training finished, stop RayOnSpark<a class="headerlink" href="#after-training-finished-stop-rayonspark" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ray_ctx</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-and-loading-a-timesequencepipeline">
<h2>Saving and Loading a <em>TimeSequencePipeline</em><a class="headerlink" href="#saving-and-loading-a-timesequencepipeline" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Save the <em>Pipeline</em> object to a file</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/tmp/saved_pipeline/my.ppl&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Load the <em>Pipeline</em> object from a file</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zoo.automl.pipeline.time_sequence</span> <span class="kn">import</span> <span class="n">load_ts_pipeline</span>
 
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">load_ts_pipeline</span><span class="p">(</span><span class="s2">&quot;/tmp/saved_pipeline/my.ppl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="prediction-and-evaluation-using-timesequencepipeline">
<h2>Prediction and Evaluation using <em>TimeSequencePipeline</em><a class="headerlink" href="#prediction-and-evaluation-using-timesequencepipeline" title="Permalink to this headline">¶</a></h2>
<p>A <em>TimeSequencePipeline</em> contains a chain of feature transformers and models, which does end-to-end time sequence prediction on input data. <em>TimeSequencePipeline</em> can be saved and loaded for future deployment.</p>
<ul class="simple">
<li>Prediction using <em>Pipeline</em> object</li>
</ul>
<p>Output dataframe look likes below (assume predict n values forward). col <code class="docutils literal notranslate"><span class="pre">datetime</span></code> is the starting timestamp.</p>
<p>|datetime|value_0|value_1|…|value_{n-1}|
| ——–|—– | ——|—|—- |
|2019-06-06|1.2|2.8|…|4.4|</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Evaluation using <em>Pipeline</em> object</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#evaluate with MSE and R2 metrics</span>
<span class="n">mse</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="s2">&quot;rs&quot;</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li>Incremental training using <em>Pipeline</em> object</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#fit with new data and train for 5 epochs</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_train_df</span><span class="p">,</span><span class="n">epoch_num</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Intel

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>